@page "/deposit"
@inject BankApp.Interfaces.IAccountService AccountService
@using BankApp.Domain
@using BankApp.Interfaces

<h3>Deposit and withdraw</h3>

@if (accounts.Count == 0)
{
    <p>No accounts created yet.</p>
}
else
{
    <table style="border-collapse: separate; border-spacing: 8px 10px;">
        <tr>
            <td>
                <select @onchange="OnAccountChanged">
                    <option value="">Select account</option>
                    @foreach (var acc in accounts)
                    {
                        <option value="@acc.Name">@acc.Name (@acc.Currency)</option>
                    }
                </select>
            </td>
        </tr>
    </table>

    @if (selectedAccount is not null)
    {
        <EditForm Model="transactionModel" OnValidSubmit="AddTransaction">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <table>
                <tr>
                    <td>
                        <label>Amount:</label>
                        <InputNumber @bind-Value="transactionModel.Amount" TValue="decimal" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Description:</label>
                        <InputText @bind-Value="transactionModel.Description" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Type:</label>
                        <InputSelect @bind-Value="transactionModel.Type">
                            <option value="@TransactionType.Deposit">Deposit</option>
                            <option value="@TransactionType.Withdrawal">Withdrawal</option>
                        </InputSelect>
                    </td>
                </tr>
            </table>

            <button type="submit">Execute</button>
        </EditForm>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color:red;">@errorMessage</p>
        }

        <h4 class="mt-4">Transactions for @selectedAccount.Name</h4>
        <ul>
            @foreach (var t in selectedAccount.Transactions)
            {
                <li>@t.Date: @t.Type - @t.Amount @selectedAccount.Currency (@t.Description)</li>
            }
        </ul>
    }
}

@code {
    private List<IBankAccount> accounts = new();
    private IBankAccount? selectedAccount;
    private TransactionModel transactionModel = new();
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        accounts = await AccountService.GetAllAccounts();
    }

    /// <summary>
    /// Handles changes to the selected account.
    /// </summary>
    /// <param name="e">The change event containing the selected account value.</param>
    private void OnAccountChanged(ChangeEventArgs e)
    {
        var selectedName = e.Value?.ToString();
        selectedAccount = accounts.FirstOrDefault(a => a.Name == selectedName);
        transactionModel = new();
        errorMessage = null;
    }

    /// <summary>
    /// Handles the addition of a new transaction to the selected account.
    /// </summary>
    private async Task AddTransaction()
    {
        errorMessage = null;

        if (selectedAccount is not BankAccount acc)
            return;

        try
        {
            if (transactionModel.Type == TransactionType.Deposit)
                acc.Deposit(transactionModel.Amount);
            else if (transactionModel.Type == TransactionType.Withdrawal)
                acc.Withdraw(transactionModel.Amount);

            var transaction = new Transaction(
                transactionModel.Amount,
                transactionModel.Description ?? "",
                transactionModel.Type,
                acc.Currency);

            acc.AddTransaction(transaction);

            await AccountService.SaveAccountsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }

        transactionModel = new();
    }

    private class TransactionModel
    {
        public decimal Amount { get; set; }
        public string? Description { get; set; }
        public TransactionType Type { get; set; }
    }
}
