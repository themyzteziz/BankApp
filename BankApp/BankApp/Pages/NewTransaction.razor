@page "/Transaction"
@inject BankApp.Interfaces.IAccountService AccountService
@using BankApp.Domain
@using BankApp.Interfaces

<h3>Överföring mellan konton</h3>

@if (accounts.Count < 2)
{
    <p>You need at least two accounts to make a transfer.</p>
}
else
{
    <EditForm Model="transferModel" OnValidSubmit="DoTransfer">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <table style="border-collapse: separate; border-spacing: 8px 10px;">
            <tr>
                <td>
                    <label>From account:</label>
                    <InputSelect @bind-Value="transferModel.FromAccountId">
                        <option value="">Select account</option>
                        @foreach (var acc in accounts)
                        {
                            <option value="@acc.Id">@acc.Name (@acc.Currency)</option>
                        }
                    </InputSelect>
                </td>
            </tr>
        </table>

        <table style="border-collapse: separate; border-spacing: 8px 10px;">
            <tr>
                <td>
                    <label>To account:</label>
                    <InputSelect @bind-Value="transferModel.ToAccountId">
                        <option value="">Select account</option>
                        @foreach (var acc in accounts)
                        {
                            <option value="@acc.Id">@acc.Name (@acc.Currency)</option>
                        }
                    </InputSelect>
                </td>
            </tr>
        </table>

        <table style="border-collapse: separate; border-spacing: 8px 10px;">
            <tr>
                <td>
                    <label>Amount:</label>
                    <InputNumber @bind-Value="transferModel.Amount" TValue="decimal" />
                </td>
            </tr>
        </table>

        <table style="border-collapse: separate; border-spacing: 8px 10px;">
            <tr>
                <td>
                    <label>Category:</label>
                    <InputSelect @bind-Value="transferModel.Category">
                        <option value="Food">Food</option>
                        <option value="Rent">Rent</option>
                        <option value="Transport">Transport</option>
                    </InputSelect>
                </td>
            </tr>
        </table>

        <button type="submit">Transfer</button>
    </EditForm>

    @if (!string.IsNullOrEmpty(message))
    {
        <p>@message</p>
    }
}

@code {
    private List<IBankAccount> accounts = new();
    private TransferModel transferModel = new();
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        accounts = await AccountService.GetAllAccounts();
    }

    /// <summary>
    /// Performs a transfer between two accounts.
    /// </summary>
    private async Task DoTransfer()
    {
        if (transferModel.FromAccountId == transferModel.ToAccountId)
        {
            message = "You cannot transfer to the same account.";
            return;
        }

        var fromAccount = accounts.FirstOrDefault(a => a.Id == transferModel.FromAccountId) as BankAccount;
        var toAccount = accounts.FirstOrDefault(a => a.Id == transferModel.ToAccountId) as BankAccount;

        if (fromAccount is null || toAccount is null)
        {
            message = "No accounts selected.";
            return;
        }

        if (transferModel.Amount <= 0 || transferModel.Amount > fromAccount.Balance)
        {
            message = "Invalid transfer amount.";
            return;
        }

        fromAccount.AddTransaction(new Transaction(
            transferModel.Amount,
            $"Transfer to {toAccount.Name} [{transferModel.Category}]",
            TransactionType.Withdrawal,
            fromAccount.Currency)
        {
            Category = transferModel.Category
        });

        toAccount.AddTransaction(new Transaction(
            transferModel.Amount,
            $"Transfer from {fromAccount.Name} [{transferModel.Category}]",
            TransactionType.Deposit,
            toAccount.Currency)
        {
            Category = transferModel.Category
        });

        await AccountService.SaveAccountsAsync();

        message = $"Transfer successful! {transferModel.Amount} {fromAccount.Currency} from {fromAccount.Name} to {toAccount.Name}.";
        transferModel = new TransferModel();
    }

    private class TransferModel
    {
        public Guid FromAccountId { get; set; }
        public Guid ToAccountId { get; set; }
        public decimal Amount { get; set; }
        public string Category { get; set; } = "";
    }
}
