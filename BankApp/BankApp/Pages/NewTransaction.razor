@page "/Transaction"
@inject BankApp.Interfaces.IAccountService AccountService
@using BankApp.Domain
@using BankApp.Interfaces

<h3>Överföring mellan konton</h3>

@if (accounts.Count < 2)
{
    <p>Du behöver minst två konton för att göra en överföring.</p>
}
else
{
    <EditForm Model="transferModel" OnValidSubmit="DoTransfer">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <table style="border-collapse: separate; border-spacing: 8px 10px;">
            <tr>
                <td>
                    <label>Från konto:</label>
                    <InputSelect @bind-Value="transferModel.FromAccountId">
                        <option value="">Välj konto</option>
                        @foreach (var acc in accounts)
                        {
                            <option value="@acc.Id">@acc.Name (@acc.Currency)</option>
                        }
                    </InputSelect>
                </td>
            </tr>
        </table>

        <table style="border-collapse: separate; border-spacing: 8px 10px;">
            <tr>
                <td>
                    <label>Till konto:</label>
                    <InputSelect @bind-Value="transferModel.ToAccountId">
                        <option value="">Byt konto</option>
                        @foreach (var acc in accounts)
                        {
                            <option value="@acc.Id">@acc.Name (@acc.Currency)</option>
                        }
                    </InputSelect>
                </td>
            </tr>
        </table>

        <table style="border-collapse: separate; border-spacing: 8px 10px;">    
            <tr>
                <td>
                    <label>Belopp:</label>
                    <InputNumber @bind-Value="transferModel.Amount" TValue="decimal" />
                </td>
            </tr>
        </table>

        <button type="submit">Överför</button>
    </EditForm>

    @if (!string.IsNullOrEmpty(message))
    {
        <p>@message</p>
    }
}

@code {
    private List<IBankAccount> accounts = new();
    private TransferModel transferModel = new();
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        accounts = await AccountService.GetAllAccounts();
    }

    /// <summary>
    /// 
    /// </summary>
    private async Task DoTransfer()
    {
        if (transferModel.FromAccountId == transferModel.ToAccountId)
        {
            message = "Du kan inte överföra till samma konto.";
            return;
        }

        var fromAccount = accounts.FirstOrDefault(a => a.Id == transferModel.FromAccountId) as BankAccount;
        var toAccount = accounts.FirstOrDefault(a => a.Id == transferModel.ToAccountId) as BankAccount;

        if (fromAccount is null || toAccount is null)
        {
            message = "Inga konton valda.";
            return;
        }

        if (transferModel.Amount <= 0 || transferModel.Amount > fromAccount.Balance)
        {
            message = "Ogiltigt överföringsbelopp.";
            return;
        }
                
        fromAccount.AddTransaction(new Transaction(
            transferModel.Amount,
            $"Överför till {toAccount.Name}",
            TransactionType.Withdrawal,
            fromAccount.Currency));

        toAccount.AddTransaction(new Transaction(
            transferModel.Amount,
            $"Överför från {fromAccount.Name}",
            TransactionType.Deposit,
            toAccount.Currency));

            await AccountService.SaveAccountsAsync();

        message = $"Överföring lyckades! {transferModel.Amount} {fromAccount.Currency} från {fromAccount.Name} till {toAccount.Name}.";
        transferModel = new TransferModel();
    }

    private class TransferModel
    {
        public Guid FromAccountId { get; set; }
        public Guid ToAccountId { get; set; }
        public decimal Amount { get; set; }
    }
}
